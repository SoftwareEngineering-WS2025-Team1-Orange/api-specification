asyncapi: '2.0.0'
info:
  title: Donation Box - Mainframe WebSocket API
  version: '1.0.0'
  description: >
    This API is used for communication between the Donation Box and the Mainframe.
    The Donation Box connects to the Mainframe via WebSocket, authenticates on the application layer,
    and then receives periodic status updates and commands regarding the mining process.
servers:
  production:
    url: 'wss://mainframe.example.com/ws'
    protocol: 'wss'  # WebSocket over TLS (secure)
    description: WebSocket connection over TLS between Donation Box and Mainframe.

channels:
  authenticate:
    description: "Channel for authenticating the DonationBox with the Mainframe."
    publish:
      operationId: 'authRequest'
      description: "Authenticate the Donation Box on the application level after WebSocket connection."
      message:
        contentType: 'application/json'
        payload:
          $ref: '#/components/schemas/AuthRequest'
    
    subscribe:
      operationId: 'authResponse'
      description: "Response from Mainframe after authentication."
      message:
        contentType: 'application/json'
        payload:
          $ref: '#/components/schemas/AuthResponse'

  containerStatusUpdate:
    description: "Regular status of selected containers requested by the Mainframe from the Donation Box."
    publish:
      operationId: 'containerStatusRequest'
      description: "Mainframe requests status update of selected from DonationBox"
      message:
        contentType: 'application/json'
        payload:
            type: 'object'
            properties:
                containerNames:
                type: 'array'
                items:
                    type: 'string'
            required:
                - containerNames
    subscribe:
      operationId: 'containerStatusUpdate'
      message:
        contentType: 'application/json'
        payload:
          $ref: '#/components/schemas/ContainerStatusUpdateResponse'

  solarStatusUpdate:
    description: "Regular status of the solar system requested by the Mainframe from the Donation Box."
    publish:
      operationId: 'solarStatusRequest'
      description: "Mainframe requests solar system status update from DonationBox"
    subscribe:
      operationId: 'solarStatusUpdate'
      message:
        contentType: 'application/json'
        payload:
          $ref: '#/components/schemas/SolarStatusUpdateResponse'

  startMining:
    description: "Request to start mining, sent by the Mainframe."
    publish:
      operationId: 'startMiningCommand'
      description: "Mainframe orders Donation Box to start mining"
      message:
        contentType: 'application/json'
        payload:
          $ref: '#/components/schemas/StartMiningRequest'

    subscribe:
      operationId: 'startMining'
      message:
        contentType: 'application/json'
        payload:
          $ref: '#/components/schemas/StartMiningResponse'

  stopMining:
    description: "Request to stop mining, sent by the Mainframe."
    publish:
      operationId: 'stopMiningCommand'
      description: 'Mainframe orders Donation Box to stop mining'
      message:
        contentType: 'application/json'
        payload:
          $ref: '#/components/schemas/StopMiningRequest'

    subscribe:
      operationId: 'stopMining'
      message:
        contentType: 'application/json'
        payload:
          $ref: '#/components/schemas/StopMiningResponse'

components:
  schemas:
    AuthRequest:
      type: object
      properties:
        username:
          type: string
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
        response:
          type: string
          enum:
            - 'success'
            - 'failure'

    ContainerStatusUpdateResponse:
      type: object
      properties:
        response:
          time:
            type: string
            format: date-time
            description: Timestamp of the poll.
          runningContainers: 
            type: array
            items: 
              type: string
          finishedContainers: 
            type: array
            items: 
              type: string
          abortedContainers: 
            type: array
            items: 
              type: string
          notFoundContainers:
            type: array
            items:
              type: string

    SolarStatusUpdateResponse:
      type: object
      properties:
        time:
          type: string
          format: date-time
          description: Timestamp of the poll.
        sysStatus:
          type: integer
          description: System status code.
        stateOfCharge:
          type: integer
          description: Current state of charge.
        production:
          $ref: '#/components/schemas/Production'
        consumption:
          $ref: '#/components/schemas/Consumption'
      required:
        - time
        - sysStatus
        - stateOfCharge
        - production
        - consumption

    Production:
      type: object
      properties:
        solar:
          type: integer
          description: Solar production value.
        add:
          type: integer
          description: Additional production value.
        grid:
          type: integer
          description: Grid production value.
      required:
        - solar
        - add
        - grid

    Consumption:
      type: object
      properties:
        battery:
          type: integer
          description: Battery consumption value.
        house:
          type: integer
          description: House consumption value.
        wallbox:
          type: integer
          description: Wallbox consumption value.
      required:
        - battery
        - house
        - wallbox

    StartMiningRequest:
      type: object
      properties:
        imageName:
          type: string
        containerName:
          type: string
        environmentVars:
          type: object

    StopMiningRequest:
      type: object
      properties:
        containerName:
          type: string

    StartMiningResponse:
      type: object
      properties:
        success:
          type: boolean
        response:
          type: string
          enum:
            - 'started_mining'
            - 'ERR_image_not_found'
            - 'ERR_could_not_start_container'
            - 'ERR_connection_to_mining_pool_failed'
            - 'ERR_authentication_on_mining_pool_failed'
            - 'ERR_other'

    StopMiningResponse:
      type: object
      properties:
        status:
          type: boolean
        response:
          type: string
          enum:
            - 'stopped_mining'
            - 'ERR_container_not_running'
            - 'ERR_other'
